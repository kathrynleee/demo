<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type="text/css">
        .node circle {
            fill: #97bbc9;
        }
        .node text {
            font: normal 15px sans-serif;
            fill: #3368a1;
        }
        .node.hide, .link.hide {
            opacity: 0.1;
        }
        .node.root circle {
            fill: #3368a1;
        }
        .link { 
            stroke: #97bbc9; 
            stroke-opacity: 1; 
            stroke-width: 2px;
        }
        body, html, svg {
			padding: 0;
			margin: 0;
			width: 100%;
			height: 100%;
		}
    </style>
</head>
<body>
<svg></svg>

<script src="d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.20/lodash.min.js"></script>

<script type="text/javascript">
    let nodes, links;
    var svg = d3.select("svg"), width = +window.innerWidth, height = +window.innerHeight, node, link;
    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().distance(200))
        .force("charge", d3.forceManyBody().strength(-120))
        .force("center", d3.forceCenter(width / 2, height / 2));

    svg.append("defs")
        .append("marker")
        .attr("id", "arrow")	
        .attr("refX", 18)
        .attr("refY", 6)
        .attr("markerWidth", 12)
        .attr("markerHeight", 12)
        .attr("orient", "auto")
        .attr('fill', '#97bbc9')
        .append("svg:path")
        .attr("d", "M2,2 L2,10 L12,6 L2,2");
    
    /******** zoom *************/
    svg.call(d3.zoom()
      .extent([[0, 0], [width, height]])
      .scaleExtent([1, 10])
      .on("zoom", zoomed));

    function zoomed({transform}) {
        svg.attr("transform", transform);
    }
    /******** zoom *************/

    var version = "bitcoin-wallet-7.07-prod";
    // get all classes
    d3.csv("https://raw.githubusercontent.com/kathrynleee/demo/main/nodes.csv").then(function(data) {
        // get all dependencies
        d3.csv("https://raw.githubusercontent.com/kathrynleee/demo/main/egdes.csv").then(function(d) {
            // filter data by version
            nodes = _.filter(data, {'version':version, 'type': 'package'});
            links = _.filter(d, {'version':version, 'type': 'package'});

            links = links.map(function(l) {
                var sourceNode = nodes.filter(n => n.id === l.version + ":" + l.source)[0];
                var targetNode = nodes.filter(n => n.id === l.version + ":" + l.target)[0];
                return {
                    source: sourceNode, target: targetNode
                };
            });

            update(links, nodes);
        });
    });
    
    function update(links, nodes) {
        link = svg.selectAll(".link")
            .data(links)
            .enter()
            .append("line")
            .attr("class", "link")
            .attr("marker-end","url(#arrow)");

        node = svg.selectAll(".node")
            .data(nodes)
            .enter()
            .append("g")
            .attr("class", "node")
            .call(d3.drag()
                  .on("drag", (event, d) => (d.x = event.x, d.y = event.y))
                  .on("drag.update", tick));
//            .on("start", (event, d) => node.filter(n => n != d).classed("hide", true))
//            .on("end", (event, d) => node.filter(n => n != d).classed("hide", false))
//            .on("start.update drag.update end.update", tick));
        
        // add extra style to root node
        node.filter(n => n.parent == "null").classed("root", true);
        
        node
          .on('mouseover', function (event, d) {
            node.filter(n => !isConnected(n,d)).classed("hide", true);
            link.filter(l => !(l.source === d || l.target === d)).classed("hide", true);      
          })
          .on('mouseout', function (event, d) {
            node.filter(n => !isConnected(n,d)).classed("hide", false);
            link.filter(l => !(l.source === d || l.target === d)).classed("hide", false);
          })
        
        node.append("circle")
            .attr("r", 13);

        node.append("text")
            .attr("text-anchor", "middle")
            .attr("dy", -15)
            .text(function (d) {return d.name;});

        simulation
            .nodes(nodes)
            .on("tick", tick)
            .force("link")
            .links(links);
    }

    function tick() {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);
        node
           .attr("transform", d => `translate(${d.x},${d.y})`);
    }

    function isConnected(a, b) {
        if(a === b) {
            return true;
        } else {
            return _.find(links, { 'source': a, 'target': b }) || _.find(links, { 'source': b, 'target': a });
        }
    }
</script>

</body>
</html>