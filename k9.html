<html>
    <head>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.17.1/cytoscape.min.js"></script>
        <script src="https://unpkg.com/klayjs@0.4.1/klay.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/cytoscape-klay@3.1.4/cytoscape-klay.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/cytoscape-expand-collapse@4.0.0/cytoscape-expand-collapse.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.20/lodash.min.js"></script>
        <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
        <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

        <style>
            #cy {
                height: 90%;
                width: 100%;
                position: absolute;
                left: 0;
                top: 40;
            }
            
            #helper {
                padding: 10px;
                width: 150px;
                position: absolute;
                right: 20px;
                top: 20px;
                border: 2px solid #97bbc9;
                border-radius: 5px;
                border-right: 4px solid #97bbc9;
                border-bottom: 4px solid #97bbc9;
                z-index: 99999;
                background: #FFF;
            }
            
            .material-icons{
                font-size: 13px;
                padding: 3px 8px;
                border: none;
                background: none;
            }
            
            #hint {
                padding: 10px;
            }
        </style>
    </head>

    <body>
         <div style="padding-top: 10px; padding-left: 10px;">
            <select name="version" id="version">
                <option value="">version</option>
                <option value="2011-02-02-k9-f75c1073111790fb396e1d9e6d476a13d565ea59">2011-02-02</option>
                <option value="2011-05-02-k9-42987cee512c4d52fb72f2bdc05bf7f5ea89f186">2011-05-02</option>
                <option value="2011-08-01-k9-9335dacd463b4452fcc79d6cb1c191821d87ae42">2011-08-01</option>
                <option value="2011-11-02-k9-a021ab71de6f6f53481e15b841cc8351441a1023">2011-11-02</option>
                <option value="2012-02-03-k9-46bf2c5be7e9d3097da736d8448ddd325aae8702">2012-02-03</option>
                <option value="2012-05-05-k9-5e3dbdcc11ac3f947294f043e08b2eb3d3292898">2012-05-05</option>
                <option value="2012-08-02-k9-592ed3ef38ae211af9e9b23a63a55f66ccb983f5">2012-08-02</option>
                <option value="2012-11-02-k9-966794f169f9a88f311807dae822ff2966112094">2012-11-02</option>
                <option value="2013-02-02-k9-cce969a6b60052aa9a9b1df70980b1f75758fba4">2013-02-02</option>
                <option value="2013-05-04-k9-56aad98d8571bc1ec2e9b38860feccc66a93376e">2013-05-04</option>
                <option value="2013-08-02-k9-fce39f0fce851d5cccd09f265836458ca1a55981">2013-08-02</option>
                <option value="2013-11-06-k9-5475f47bcfeee92301e793cb9da7b08648525d25">2013-11-06</option>
                <option value="2014-02-08-k9-94301e7e3b832522e89af863bfddcb96cdd6c9b5">2014-02-08</option>
                <option value="2014-05-02-k9-9c5b9cce90b8920a17706851c38322e44f34ce08">2014-05-02</option>
                <option value="2014-08-06-k9-7aa4c1308e4e17844d81a85485a0e03d619962b6">2014-08-06</option>
                <option value="2014-11-10-k9-e64ca84f1bc9e7e09c0ba87735d0982f4a476d55">2014-11-10</option>
                <option value="2015-02-04-k9-80221dace86b38d120fbf5c2e51b137abcacf1c8">2015-02-04</option>
                <option value="2015-05-02-k9-b660d45b6c0ba546ceb17728e7a98fb95af66991">2015-05-02</option>
                <option value="2015-08-03-k9-93f896516490725b61ad91f6b48e355c5e86a3cd">2015-08-03</option>
                <option value="2015-11-06-k9-9e012384a1af735e221d8a341f95728284699dd7">2015-11-06</option>
                <option value="2016-02-02-k9-61771533587f162eea973629aab38e3f6c3cb66d">2016-02-02</option>
                <option value="2016-05-02-k9-28232ed10824e4a65a68d3e9b5ff017bf7886543">2016-05-02</option>
                <option value="2016-08-01-k9-d276bbda3ea65284487d92caa3577db0dd5ae1e6">2016-08-01</option>
                <option value="2016-11-03-k9-0617d4250f0f3289f013185704e56bd73022bc5d">2016-11-03</option>
                <option value="2017-02-03-k9-957b61809261ea59e56da9ce276b55e711195379">2017-02-03</option>
                <option value="2017-05-02-k9-754837d5ef5d9ffeb91dbf18c562ad3b01bfae76">2017-05-02</option>
                <option value="2017-08-05-k9-98971a4e4c72d5144bf5e04bcd6d998de44d009e">2017-08-05</option>
                <option value="2017-11-15-k9-c113c23f5e23b269068aea3e8980a25b06e7f6e9">2017-11-15</option>
                <option value="2018-02-01-k9-ff9369b3cb54867b89c6d871811f14a7ae584dcd">2018-02-01</option>
                <option value="2018-05-01-k9-e36e6701c227cfe05ae129c019ab0e0b13f9530c">2018-05-01</option>
                <option value="2018-08-02-k9-ae38778ec1fc85b1c563be8c23c14645c30248b3">2018-08-02</option>
                <option value="2018-11-03-k9-424b71cdfceed7394290528dce1e6f79f2d001d3">2018-11-03</option>
                <option value="2019-02-07-k9-2d9a12286ba84abe3af2db9d466e31990866ae2f">2019-02-07</option>
                <option value="2019-05-01-k9-e85e91c923a70ec27632a2575acf71366b483306">2019-05-01</option>
                <option value="2019-08-03-k9-766a13a5d916bd5c380be2953e3335a16117d2a2">2019-08-03</option>
                <option value="2019-11-03-k9-2fcef664aa1aa96fccaeacb5aa66297dd50edbf4">2019-11-03</option>
                <option value="2020-02-05-k9-611a57fb0e08741b216a8ac8f09259eba5f485f8">2020-02-05</option>
            </select>
            <button id="help" class="material-icons">help</button>
        </div>
        <div id="cy"></div>
        <div id="helper">
            <div>
                <button id="close" class="material-icons" style="font-size: 15px;">close</button>
            </div>
            <div id="hint"></div>
            <div id="options">
                <select name="dependencies" id="dependencies">
                    <option value="show">Show dependencies</option>
                    <option value="hide">Hide dependencies</option>
                </select>
                <button id="collapse">Collapse all</button>
                <button id="expand">Expand all</button>
                <div id="roles">
                    <div class="role">
                        <input type="checkbox" checked id="Controller" value="Controller">
                        <label for="Controller">Controller</label>
                    </div>
                    <div class="role">
                        <input type="checkbox" checked id="Coordinator" value="Coordinator">
                        <label for="Coordinator">Coordinator</label>
                    </div>
                    <div class="role">
                        <input type="checkbox" checked id="Interfacer" value="Interfacer">
                        <label for="Interfacer">Interfacer</label>
                    </div>
                    <div class="role">
                        <input type="checkbox" checked id="InformationHolder" value="Information Holder">
                        <label for="InformationHolder">Information Holder</label>
                    </div>
                    <div class="role">
                        <input type="checkbox" checked id="ServiceProvider" value="Service Provider">
                        <label for="ServiceProvider">Service Provider</label>
                    </div>
                    <div class="role">
                        <input type="checkbox" checked id="Structurer" value="Structurer">
                        <label for="Structurer">Structurer</label>
                    </div>
                </div>
            </div>
        </div>
    </body>
    
<script>    
    var original; // all data
    var selected; // store selected node
    var cy;
    var currentData = { nodes: [], edges: [] };

    $('#options, #help').hide();
    
    $('#help').on('click', function(e) {
        $('#helper').show();
    });
 
    $('#role').on('change', function(e){
        var role = $('#role').val();
        cy.elements().removeClass('remove');
        if(role != "") {
            expandAll();
            var nodes = cy.elements('node[role="'+ role + '"]');
            var parents = nodes.parent();
            cy.elements().not(nodes).not(parents).addClass('remove');
            cy.layout(options).run();
        } else {
            cy.layout(options).run();
            collapseAll();
        }
    });
    
    $('#Controller').change(function() {
        if(!$(this).is(":checked")) {
            cy.elements('node[role="Controller"]').addClass('remove');
        } else {
            cy.elements('node[role="Controller"]').removeClass('remove');
        }       
    });
    
    $('#Coordinator').change(function() {
        if(!$(this).is(":checked")) {
            cy.elements('node[role="Coordinator"]').addClass('remove');
        } else {
            cy.elements('node[role="Coordinator"]').removeClass('remove');
        }       
    });
    
    $('#Interfacer').change(function() {
        if(!$(this).is(":checked")) {
            cy.elements('node[role="Interfacer"]').addClass('remove');
        } else {
            cy.elements('node[role="Interfacer"]').removeClass('remove');
        }       
    });
    
    $('#InformationHolder').change(function() {
        if(!$(this).is(":checked")) {
            cy.elements('node[role="Information Holder"]').addClass('remove');
        } else {
            cy.elements('node[role="Information Holder"]').removeClass('remove');
        }       
    });
    
    $('#ServiceProvider').change(function() {
        if(!$(this).is(":checked")) {
            cy.elements('node[role="Service Provider"]').addClass('remove');
        } else {
            cy.elements('node[role="Service Provider"]').removeClass('remove');
        }       
    });
    
    $('#Structurer').change(function() {
        if(!$(this).is(":checked")) {
            cy.elements('node[role="Structurer"]').addClass('remove');
        } else {
            cy.elements('node[role="Structurer"]').removeClass('remove');
        }       
    });
    
    $('#close').on('click', function(e) {
        $('#helper').hide();
        $('#help').show();
    });
    
    $('#help').on('click', function(e) {
        $('#helper').show();
        $('#help').hide();
    });
    
    $('#collapse').on('click', function(e) {
        collapseAll();
    });
    
    $('#expand').on('click', function(e) {
        expandAll();
    });

    function expandAll(){
        var api = cy.expandCollapse('get');
        api.expandAll();
        cy.layout(options).run();
    }
    
    function collapseAll(){
        var api = cy.expandCollapse('get');
        api.collapseAll({
            layoutBy: {
                name: 'circle',
                avoidOverlap: true
            }
        }); 
        api.collapseAllEdges(); 
    }
    
    $('#version').on('change', function() {
        var version = $("#version").val();
        $('#Controller, #Coordinator, #Interfacer, #InformationHolder, #ServiceProvider, #Structurer').prop("checked", true);
        
        $("#hint").html("Click on a node to expand the package.");
        currentData = { nodes: [], edges: [] };
        
        _.forEach(original.nodes, function(d) {
            if(d.data.version === version) {
                currentData.nodes.push(d);
            }
        });

        _.forEach(original.edges, function(d) {
            if(d.data.version === version) {
                currentData.edges.push(d);
            }
        });
        
        var all = cy.elements();
        cy.remove(all);
        addElements(currentData)
            .then(() => collapseAll());
        $('#options, #collapse, #expand, #role').show();
    });
    
    $('#dependencies').on('change', function(e) {
        if($('#dependencies').val() == 'show') {
            cy.elements('edge').removeClass('remove');
        } else {
            cy.elements('edge').not('edge.cy-expand-collapse-collapsed-edge, edge.cy-expand-collapse-meta-edge').addClass('remove');
            cy.layout(options).run();
        }
    });
    
        $.getJSON('https://raw.githubusercontent.com/kathrynleee/demo/main/k9-data.json', function (data) {
            original = data;
            
            cy = cytoscape({
                container: $('#cy'),
                layout: options,
                boxSelectionEnabled: true,
                style: cytoscape.stylesheet()
                    .selector('node')
                    .css({
                        'label': 'data(name)',
                        'background-color': '#a9b6c2',
                        'text-valign': 'top',
                        'text-halign': 'center',
                        'color': '#3b444d',
                        'font-size' : '20',
                        'text-wrap': 'wrap',
                        'text-max-width': '20',
                        'width' : '30',
                        'height': '30'
                    })
                    .selector('edge')
                    .css({
                        'line-color': '#a9b6c2',
                        'width': 3,
                        'target-arrow-color': '#a9b6c2',
                        'target-arrow-shape': 'triangle',
                        'arrow-scale': 2,
                        'curve-style': 'bezier',
                        'opacity': 0.7
                    })
                    .selector('node:parent, node:parent.highlight, node:parent.target')
                    .css({
                        'text-valign': 'top',
                        'text-halign': 'center',
                        'background-color': 'white',
                        'color': '#3b444d',
                        'border-color': '#a9b6c2',
                        'border-width': 2
                    })
                    .selector('node.cy-expand-collapse-collapsed-node')
                    .css({
                        'background-color': '#a9b6c2',
//                        'border-color': '#cbcde6',
//                        'border-width': 5,
                        'color': '#3b444d',
                        'shape': 'square',
                        'width' : '40',
                        'height': '40'
                    })     
                    .selector('edge.cy-expand-collapse-collapsed-edge')
                    .css({
                        'line-color': '#a9b6c2',
                        'target-arrow-color': '#a9b6c2',
                        'target-arrow-shape': 'triangle',
                        'arrow-scale': 1,
                        'opacity': 0.7,
                        'curve-style': 'bezier',
                        'width': function (edge) {
                            var size = edge.data("collapsedEdges").length;
                            var width = _.round((Math.log(size) / Math.log(1.5) + Number.EPSILON)) + 1;
                            return width;
                        }
                    })
                    .selector('edge.cy-expand-collapse-meta-edge')
                    .css({
                        'line-color': '#a9b6c2',
                        'target-arrow-color': '#a9b6c2',
                        'target-arrow-shape': 'triangle',
                        'arrow-scale': 1,
                        'curve-style': 'bezier',
                        'width': 3,
                        'opacity': 0.7,
                    })
                    .selector('.remove')
                    .css({
                        'display': 'none'
                    })
                    .selector('node[role="Controller"]')
                    .css({
                        'background-color': '#9174ab',
                        'color': '#9174ab',
                        'shape' : 'ellipse',
                    })
                    .selector('node[role="Coordinator"]')
                    .css({
                        'background-color': '#568563',
                        'color': '#568563',
                        'shape' : 'ellipse',
                    })
                    .selector('node[role="Interfacer"]')
                    .css({
                        'background-color': '#E9AB45',
                        'color': '#E9AB45',
                        'shape' : 'ellipse',
                    })
                    .selector('node[role="Information Holder"]')
                    .css({
                        'background-color': '#a63a5e',
                        'color': '#a63a5e',
                        'shape' : 'ellipse',
                    })
                    .selector('node[role="Service Provider"]')
                    .css({
                        'background-color': '#4d82b0',
                        'color': '#4d82b0',
                        'shape' : 'ellipse',
                    })
                    .selector('node[role="Structurer"]')
                    .css({
                        'background-color': '#e6a1b2',
                        'color': '#e6a1b2',
                        'shape' : 'ellipse',
                    })
                    ,
                elements: [],
                ready: function() {
                    
                    $("#hint").html("Start by choosing one version.");
                    
                    var api = this.expandCollapse({
                        layoutBy: options,
                        animate: false,
                        undoable: false
                    });

                    api.collapseAll({
                        layoutBy: {
                            name: 'circle',
                            avoidOverlap: true
                        }
                    }); 

                    api.collapseAllEdges(); 
                    
                    api.disableCue();

                    this.on('tap', 'node.cy-expand-collapse-collapsed-node', function(e) {
                        var target = e.target;
                        var api = cy.expandCollapse('get');
                        api.expand(target);
                        selected = target;
//                        alert(target._private.data.name)
                        $('#collapse, #expand, #role').hide();
                        $('#dependencies').show();
                        $("#hint").html("Try to click on a node. Nodes are draggable.");
                    });
                    
                    this.on('click', function(e) {
                        if (e.target === cy) {
                            
                            var api = cy.expandCollapse('get');
                            api.collapse(selected);
                            cy.elements().removeClass('remove');
                            
                            cy.layout({
                                name: 'circle',
                                avoidOverlap: true
                            }).run();
                            
                            api.collapseAll({
                                layoutBy: {
                                    name: 'circle',
                                    avoidOverlap: true
                                }
                            }); 
                            $('#dependencies').hide();
                            $('#collapse, #expand').show();
                            $("#hint").html("Try to click on a node. Nodes are draggable.");
                        }
                    });
                    
                    $('#dependencies').hide();
                    
                    this.on('tap', 'node', function(e) {
                        var target = e.target;
                        remove();
                        if(!target.hasClass('cy-expand-collapse-collapsed-node')) {
                            // is parent node
                            if(target.isParent()) {
                                var nodes = target.union(target.children());
                                var edges = nodes.connectedEdges();
                                var parent = target.parent();
                                cy.elements().not(nodes).not(parent).not(edges).addClass('remove');
                                cy.layout(options).run();
                                $('#collapse, #expand, #role').hide();
                                $("#hint").html("Try to click on a node. Nodes are draggable.</br>Go back by clicking on background outside the package.");
                            } else {
                                selected = target._private.data.id;
                                cy.destroy();
                            }
                        } else {
                            
                            $('#collapse, #expand, #role').show();
                            $("#hint").html("Click on a node to expand the package.");
                        }
                    });
                    
                }
            });
        });
    
    function remove(){
        cy.elements().removeClass(['target', 'highlight', 'third', 'remove', 'added', 'removed', 'roleChanged']);
    }
    
    async function addElements(eles){
        cy.add(eles);
    }
    
    var options = {
        name: 'klay',
        nodeDimensionsIncludeLabels: true, 
        fit: true, 
        padding: 20,
        transform: function( node, pos ){ return pos; }, 
        klay: {
            addUnnecessaryBendpoints: false,
            aspectRatio: 1.6,
            borderSpacing: 20,
            compactComponents: true,
            crossingMinimization: 'LAYER_SWEEP',
            cycleBreaking: 'GREEDY',
            direction: 'DOWN',
            edgeRouting: 'ORTHOGONAL',
            edgeSpacingFactor: 0.5,
            feedbackEdges: true,
            fixedAlignment: 'NONE',
            mergeEdges: false,
            nodeLayering:'NETWORK_SIMPLEX',
            nodePlacement:'SIMPLE',
            spacing: 10,
            thoroughness: 7
        }
    };
</script>
</html>