<html>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.17.1/cytoscape.min.js"></script>

<style>
    @font-face {
        font-family: themeFont;
        src: url(font.ttf);
    }
    #cy {
        height: 100%;
        width: 100%;
        position: absolute;
        left: 0;
        top: 0;
    }
</style>

<body>
    <div id="cy"></div>
</body>
    
<script>
    var original;
    $.getJSON('json2.js', function (data) {
        original = data;
        var cy = cytoscape({
            container: $('#cy'),
            boxSelectionEnabled: false,
            style: cytoscape.stylesheet()
                .selector('node')
                .css({
                    'label': 'data(name)',
                    'background-color': '#97bbc9',
                    'text-valign': 'top',
                    'text-halign': 'center',
                    'color': '#3368a1',
                    'font-size' : '20',
                    'font-family': 'themeFont',
                    'text-wrap': 'wrap',
                    'text-max-width': '20',
                    'width' : '30',
                    'height': '30'
                })
                .selector('node:parent')
                .css({
                    'text-valign': 'top',
                    'text-halign': 'center',
                    'background-color': 'white',
                    'border-color': '#97bbc9',
                    'border-width': 3
                })
                .selector('edge')
                .css({
                    'line-color': '#97bbc9',
                    'width': 2,
                    'target-arrow-color': '#97bbc9',
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier'
                })
                .selector('.target')
                .css({
                    'background-color': '#f2948d',
                    'color': '#f2948d',
                    'font-family': 'themeFont'
                })
                .selector('.faded')
                .css({
                    'opacity': 0.05,
                    'text-opacity': 0
                })
                .selector('node.highlight')
                .css({
                    'background-color': '#3368a1',
                    'color': '#3368a1',
                    'font-family': 'themeFont'
                })
                .selector('edge.highlight')
                .css({
                    'target-arrow-color': '#3368a1',
                    'line-color': '#3368a1'
                }),
            elements: data,
            ready: function() {
            }
        });
        
        // get node info
        cy.on('tap', 'node', function(e) {
            var target = e.target;

            // is parent node
            if(target.parent().length == 0) {
                var nodes = target.union(target.children().predecessors()).union(target.children().successors()).union(target.children()).union(target.children().predecessors().parent()).union(target.children().successors().parent());
                removeAll();
                cy.add(nodes);
                setLayout();
                cy.elements().not(target).not(target.children().predecessors().parent()).not(target.children().successors().parent()).addClass('highlight');
                
            } else {
                var nodes = target.union(target.predecessors()).union(target.successors()).union(target.parent()).union(target.predecessors().parent()).union(target.successors().parent());
                removeAll();
                cy.add(nodes);
                setLayout();
                target.union(target.predecessors()).union(target.successors()).addClass('highlight');
                target.addClass('target');
            }
        });
        
        // click on background
        cy.on('click', function(e) {
            if (e.target === cy) {
                var all = cy.elements();
                cy.remove(all);
                cy.add(original);
                setLayout();
            }
        });
        
        var removeAll = function() {
            var all = cy.elements();
            cy.remove(all);
        }
        
        var setLayout = function() {
            var layout = cy.layout({
              name: 'random',
              fit: true, // whether to fit the viewport to the graph
              directed: false, // whether the tree is directed downwards (or edges can point in any direction if false)
              padding: 30, // padding on fit
              circle: false, // put depths in concentric circles if true, put depths top down if false
              grid: false, // whether to create an even grid into which the DAG is placed (circle:false only)
              spacingFactor: 1.5, // positive spacing factor, larger => more space between nodes (N.B. n/a if causes overlap)
              boundingBox: undefined, // constrain layout bounds; { x1, y1, x2, y2 } or { x1, y1, w, h }
              avoidOverlap: true, // prevents node overlap, may overflow boundingBox if not enough space
              nodeDimensionsIncludeLabels: false, // Excludes the label when calculating node bounding boxes for the layout algorithm
              roots: undefined, // the roots of the trees
              maximal: false, // whether to shift nodes down their natural BFS depths in order to avoid upwards edges (DAGS only)
              animate: false, // whether to transition the node positions
              animationDuration: 500, // duration of animation in ms if enabled
              animationEasing: undefined, // easing of animation if enabled,
              animateFilter: function ( node, i ){ return true; }, // a function that determines whether the node should be animated.  All nodes animated by default on animate enabled.  Non-animated nodes are positioned immediately when the layout starts
              ready: undefined, // callback on layoutready
              stop: undefined, // callback on layoutstop
              transform: function (node, position ){ return position; }
            });

            layout.run();
        }
        
    }); // on dom ready
</script>
</html>