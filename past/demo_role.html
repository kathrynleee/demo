<html>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.17.1/cytoscape.min.js"></script>

<style>
    #cy {
        height: 100%;
        width: 100%;
        position: absolute;
        left: 0;
        top: 40;
    }
</style>

<body>
    <div id="cy"></div>
    <div>
    <button id="depth1">1</button>
    <button id="depth2">2</button>
    <button id="depth3">3</button>
    <button id="in">in</button>
    <button id="out">out</button>
    <button id="clear">clear</button>
    <select name="hover" id="hover">
        <option value="">No hover</option>
        <option value="path">Show path</option>
    </select>
    <select name="role" id="role">
        <option value="">All roles</option>
        <option value="ServiceProvider">Service Provider</option>
        <option value="InformationHolder">Information Holder</option>
        <option value="Coordinator">Coordinator</option>
        <option value="Interfacer">Interfacer</option>
        <option value="Controller">Controller</option>
        <option value="Structurer">Structurer</option>
    </select>
    </div>
    <img src="role.png" style="max-height: 26px;padding-top: 8px;">
</body>
    
<script>
    var original; // original data
    
    $.getJSON('https://raw.githubusercontent.com/kathrynleee/demo/main/wallet-7.44parent_json.js', function (data) {
        original = data;
        var cy = cytoscape({
            container: $('#cy'),
            boxSelectionEnabled: true,
            style: cytoscape.stylesheet()
                .selector('node')
                .css({
                    'label': 'data(name)',
                    'background-color': '#97bbc9',
                    'text-valign': 'top',
                    'text-halign': 'center',
                    'color': '#3368a1',
                    'font-size' : '20',
                    'text-wrap': 'wrap',
                    'text-max-width': '20',
                    'width' : '30',
                    'height': '30'
                })
                .selector('node[role="Controller"]')
                .css({
                    'shape': 'round-diamond'
                })
                .selector('node[role="Coordinator"]')
                .css({
                    'shape': 'round-pentagon'
                })
                .selector('node[role="Interfacer"]')
                .css({
                    'shape': 'round-octagon'
                })
                .selector('node[role="Information Holder"]')
                .css({
                    'shape': 'round-rectangle',
                    'background-color': 'white',
                    'border-color': '#97bbc9',
                    'border-width': 3,
                    'width' : '27',
                    'height': '27'
                })
                .selector('node[role="Service Provider"]')
                .css({
                    'shape': 'ellipse',
                    'background-color': 'white',
                    'border-color': '#97bbc9',
                    'border-width': 3,
                    'width' : '27',
                    'height': '27'
                })
                .selector('node[role="Structurer"]')
                .css({
                    'shape': 'round-tag'
                })
                .selector('node:parent')
                .css({
                    'text-valign': 'top',
                    'text-halign': 'center',
                    'background-color': 'white',
                    'color': '#97bbc9',
                    'border-color': '#97bbc9',
                    'border-width': 2
                })
                .selector('edge')
                .css({
                    'line-color': '#97bbc9',
                    'width': 3,
                    'target-arrow-color': '#97bbc9',
                    'target-arrow-shape': 'triangle',
                    'arrow-scale': 2,
                    'curve-style': 'bezier'
                })
//                .selector('.faded')
//                .css({
//                    'opacity': 0.05,
//                    'text-opacity': 0
//                })
                .selector('node.highlight')
                .css({
                    'background-color': '#3368a1',
                    'color': '#3368a1'
                })
                .selector('node[role="Information Holder"].highlight')
                .css({
                    'background-color': 'white',
                    'border-color': '#3368a1'
                })
                .selector('node[role="Service Provider"].highlight')
                .css({
                    'background-color': 'white',
                    'border-color': '#3368a1'
                })
                .selector('edge.highlight')
                .css({
                    'target-arrow-color': '#3368a1',
                    'line-color': '#3368a1'
                })
                .selector('node.third')
                .css({
                    'background-color': '#eaedc5',
                    'color': '#eaedc5'
                })
                .selector('node[role="Information Holder"].third')
                .css({
                    'background-color': 'white',
                    'border-color': '#eaedc5'
                })
                .selector('node[role="Service Provider"].third')
                .css({
                    'background-color': 'white',
                    'border-color': '#eaedc5'
                })
                .selector('edge.third')
                .css({
                    'target-arrow-color': '#eaedc5',
                    'line-color': '#eaedc5'
                })
                .selector('node.target')
                .css({
                    'background-color': '#ed5e53',
                    'color': '#ed5e53'
                })
                .selector('node[role="Information Holder"].target')
                .css({
                    'background-color': 'white',
                    'border-color': '#ed5e53'
                })
                .selector('node[role="Service Provider"].target')
                .css({
                    'background-color': 'white',
                    'border-color': '#ed5e53'
                })
//                .selector('node.selected2')
//                .css({
//                    'background-color': 'purple',
//                    'color': 'purple'
//                })
                .selector('edge.hover')
                .css({
                    'target-arrow-color': '#a9b3cf',
                    'line-color': '#a9b3cf'
                })
                .selector('node.hover')
                .css({
                    'background-color': '#a9b3cf',
                    'color': '#a9b3cf'
                })
//                .selector('edge.path')
//                .css({
//                    'target-arrow-color': '#c97999',
//                    'line-color': '#c97999'
//                })
//                .selector('node.path')
//                .css({
//                    'background-color': '#c97999',
//                    'color': '#c97999'
//                })
                .selector('.hide')
                .css({
                    'opacity': 0
                })
                ,
            elements: data,
            ready: function() {
            }
        });
        
//        cy.elements().not('node:parent').remove();
//        cy.on('tap', 'node', function(e) {
//            var target = e.target;
//            if(target.parent().length == 0) {
//
//            }
//        });
        
        var selected; // store selected node
        var selected2;
        // get node info
        cy.on('tap', 'node', function(e) {
            cy.elements().removeClass(['target','selected2']);
            var target = e.target;
            
            // is parent node
            if(target.isParent()) {
                var nodes = target.union(target.children().predecessors()).union(target.children().successors()).union(target.children()).union(target.children().predecessors().parent()).union(target.children().successors().parent());
                removeAll();
                cy.add(nodes);
                setLayout();
                cy.elements().not(target).not(target.children().predecessors().parent()).not(target.children().successors().parent()).addClass('highlight');
                
            } else {
                selected = target;
                var nodes = target.union(target.predecessors()).union(target.successors()).union(target.parent()).union(target.predecessors().parent()).union(target.successors().parent());
                removeAll();
                cy.add(nodes);
                setLayout();
                target.union(target.predecessors()).union(target.successors()).addClass('highlight');
                target.addClass('target');
            }
        });
        
        // click on background
        cy.on('click', function(e) {
            if (e.target === cy) {
                selected = undefined;
                var all = cy.elements();
                cy.remove(all);
                cy.add(original);
                setLayout();
            }
        });
      
        var elements;
        
        var dependencyHover = function(e) {
            var target = e.target;
            if(target !== selected && selected !== undefined && !target.isParent()) {
                target.neighborhood().addClass('hover');
                cy.elements().not(target).not(target.neighborhood()).addClass('hide');
            }
        };
        var removeDependencyHoverClass = function() {
            cy.elements().removeClass(['hover','hide']);
        };
        
        var pathHover = function(e) {
            var target = e.target;
            if(target !== selected && selected !== undefined && !target.isParent()) {
                var aStar = cy.elements().aStar({ root: selected, goal: target });
                var elementsInPath = aStar.path.select();       
                elementsInPath.not(selected).addClass('path');
                cy.elements().not(elementsInPath).not(selected).addClass('hide');
            }
        };
        var removePathHoverClass = function() {
            cy.elements().removeClass(['path','hide']);
        };
        
        $('#hover').on('change', function() {
            if(this.value == 'path') {
                cy.on('mouseover', 'node', pathHover);
                cy.on('mouseout', 'node', removePathHoverClass);
            } else if(this.value == '') {
                cy.removeListener('mouseover', 'node', pathHover);
                cy.removeListener('mouseout', 'node', removePathHoverClass);
            }
        });
        
        $('#role').on('change', function() {
            if(this.value == 'ServiceProvider') {
                removeAll();
                cy.add(original);
                var nodes = cy.elements('node[role="Service Provider"]');
                removeAll();
                cy.add(nodes);
                setLayout();
            } else if(this.value == 'InformationHolder') {
                removeAll();
                cy.add(original);
                var nodes = cy.elements('node[role="Information Holder"]');
                removeAll();
                cy.add(nodes);
                setLayout();
            } else if(this.value == 'Controller') {
                removeAll();
                cy.add(original);
                var nodes = cy.elements('node[role="Controller"]');
                removeAll();
                cy.add(nodes);
                setLayout();
            } else if(this.value == 'Coordinator') {
                removeAll();
                cy.add(original);
                var nodes = cy.elements('node[role="Coordinator"]');
                removeAll();
                cy.add(nodes);
                setLayout();
            } else if(this.value == 'Interfacer') {
                removeAll();
                cy.add(original);
                var nodes = cy.elements('node[role="Interfacer"]');
                removeAll();
                cy.add(nodes);
                setLayout();
            } else if(this.value == 'Structurer') {
                removeAll();
                cy.add(original);
                var nodes = cy.elements('node[role="Structurer"]');
                removeAll();
                cy.add(nodes);
                setLayout();
            } else if(this.value == '') {
                removeAll();
                cy.add(original);
                setLayout();
            } 
        });
        
        var traverse;
        $('#in').click(function() {
            traverse = 'in';
            cy.elements().removeClass(['target','highlight','third']);
            cy.add(original);
            var firstLvlNodes = selected.incomers();
            var secondLvlNodes = firstLvlNodes.incomers();
            var thirdLvlNodes = secondLvlNodes.incomers();
            removeAll();
            cy.add(selected);
            cy.add(firstLvlNodes);
            cy.add(secondLvlNodes);
            cy.add(thirdLvlNodes);
            setLayout();
            firstLvlNodes.addClass('highlight');
            thirdLvlNodes.not(selected).not(firstLvlNodes).not(secondLvlNodes).addClass('third');
            selected.addClass('target');
        });
        
        $('#out').click(function() {
            traverse = 'out';
            cy.elements().removeClass(['target','highlight','third']);
            cy.add(original);
            var firstLvlNodes = selected.outgoers();
            var secondLvlNodes = firstLvlNodes.outgoers();
            var thirdLvlNodes = secondLvlNodes.outgoers();
            removeAll();
            cy.add(selected);
            cy.add(firstLvlNodes);
            cy.add(secondLvlNodes);
            cy.add(thirdLvlNodes);
            setLayout();
            firstLvlNodes.addClass('highlight');
            thirdLvlNodes.not(selected).not(firstLvlNodes).not(secondLvlNodes).addClass('third');
            selected.addClass('target');
        });
        
        $('#depth1').click(function() {
            if(traverse == 'out') {
                var firstLvlNodes = selected.outgoers();
                var all = cy.elements().not(firstLvlNodes).not(selected);
                cy.remove(all);
            } else if(traverse == 'in') {
                var firstLvlNodes = selected.incomers();
                var all = cy.elements().not(firstLvlNodes).not(selected);
                cy.remove(all);
            } else {
                cy.add(original);
                var firstLvlNodes = selected.outgoers().union(selected.incomers());
                removeAll();
                cy.add(selected);
                cy.add(firstLvlNodes);
            }
        });
        
        $('#depth2').click(function() {
            if(traverse == 'out') {
                cy.elements().removeClass(['target','highlight','third']);
                cy.add(original);
                var firstLvlNodes = selected.outgoers();
                var secondLvlNodes = firstLvlNodes.outgoers();
                removeAll();
                cy.add(selected);
                cy.add(firstLvlNodes);
                cy.add(secondLvlNodes);
                setLayout();
                firstLvlNodes.addClass('highlight');
                selected.addClass('target');
            } else if(traverse == 'in') {
                cy.elements().removeClass(['target','highlight','third']);
                cy.add(original);
                var firstLvlNodes = selected.incomers();
                var secondLvlNodes = firstLvlNodes.incomers();
                removeAll();
                cy.add(selected);
                cy.add(firstLvlNodes);
                cy.add(secondLvlNodes);
                setLayout();
                firstLvlNodes.addClass('highlight');
                selected.addClass('target');
            }
            
        });
        
        $('#depth3').click(function() {
            if(traverse == 'out') {
                $('#out').click();
            } else if(traverse == 'in') {
                $('#in').click();
            }
        });
        
        $('#clear').click(function() {
            selected = undefined;
            selected2 = undefined;
            traverse = undefined;
            cy.elements().removeClass(['target','highlight','third']);
        });
        
        var removeAll = function() {
            var all = cy.elements();
            cy.remove(all);
        }
        
        var setLayout = function() {
            var layout = cy.layout({
              name: 'random',
              fit: true, // whether to fit the viewport to the graph
              directed: false, // whether the tree is directed downwards (or edges can point in any direction if false)
              padding: 30, // padding on fit
              circle: false, // put depths in concentric circles if true, put depths top down if false
              grid: false, // whether to create an even grid into which the DAG is placed (circle:false only)
              spacingFactor: 1.5, // positive spacing factor, larger => more space between nodes (N.B. n/a if causes overlap)
              boundingBox: undefined, // constrain layout bounds; { x1, y1, x2, y2 } or { x1, y1, w, h }
              avoidOverlap: true, // prevents node overlap, may overflow boundingBox if not enough space
              nodeDimensionsIncludeLabels: false, // Excludes the label when calculating node bounding boxes for the layout algorithm
              roots: undefined, // the roots of the trees
              maximal: false, // whether to shift nodes down their natural BFS depths in order to avoid upwards edges (DAGS only)
              animate: false, // whether to transition the node positions
              animationDuration: 500, // duration of animation in ms if enabled
              animationEasing: undefined, // easing of animation if enabled,
              animateFilter: function ( node, i ){ return true; }, // a function that determines whether the node should be animated.  All nodes animated by default on animate enabled.  Non-animated nodes are positioned immediately when the layout starts
              ready: undefined, // callback on layoutready
              stop: undefined, // callback on layoutstop
              transform: function (node, position ){ return position; }
            });

            layout.run();
        }
        
    }); // on dom ready
</script>
</html>